<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Agent Test - Voice Platform</title>
    <script type="module">
        // Import LiveKit as ES module and expose it globally
        import * as LiveKitSDK from 'https://cdn.skypack.dev/livekit-client@1.15.13';
        
        // Make it available globally
        window.LiveKit = LiveKitSDK;
        console.log('LiveKit ES module loaded and exposed globally:', LiveKitSDK);
        
        // Trigger initialization
        window.dispatchEvent(new CustomEvent('livekitReady'));
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
        }

        .voice-test-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 90%;
            text-align: center;
        }

        .agent-info {
            margin-bottom: 2rem;
        }

        .agent-info h1 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-size: 2rem;
        }

        .agent-info p {
            color: #666;
            font-size: 1.1rem;
        }

        .connection-status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin: 2rem 0;
            border-left: 4px solid #e74c3c;
        }

        .connection-status.connected {
            border-left-color: #27ae60;
            background: #d5f5d6;
        }

        .connection-status.connecting {
            border-left-color: #f39c12;
            background: #fef5e7;
        }

        .voice-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 2rem 0;
        }

        .voice-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .voice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-connect {
            background: #3498db;
            color: white;
        }

        .btn-connect:hover:not(:disabled) {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-disconnect {
            background: #e74c3c;
            color: white;
        }

        .btn-disconnect:hover:not(:disabled) {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-mute {
            background: #f39c12;
            color: white;
        }

        .btn-mute:hover:not(:disabled) {
            background: #e67e22;
        }

        .audio-visualizer {
            width: 100%;
            height: 100px;
            background: #2c3e50;
            border-radius: 10px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .audio-bars {
            display: flex;
            align-items: center;
            gap: 4px;
            height: 80%;
        }

        .audio-bar {
            width: 4px;
            background: #3498db;
            border-radius: 2px;
            transition: height 0.1s ease;
            min-height: 4px;
        }

        .agent-status {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 1rem 0;
            padding: 0.5rem;
            border-radius: 8px;
        }

        .status-initializing {
            background: #f8f9fa;
            color: #666;
        }

        .status-listening {
            background: #d5f5d6;
            color: #27ae60;
        }

        .status-thinking {
            background: #fef5e7;
            color: #f39c12;
        }

        .status-speaking {
            background: #e3f2fd;
            color: #2196f3;
        }

        .conversation-log {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 2rem;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
        }

        .conversation-entry {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
        }

        .conversation-entry.user {
            background: #e3f2fd;
            margin-left: 2rem;
        }

        .conversation-entry.agent {
            background: #f3e5f5;
            margin-right: 2rem;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #2c3e50;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: white;
            transform: translateY(-2px);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #f5c6cb;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulsing {
            animation: pulse 1s infinite;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff40;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <a href="dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
    
    <div class="voice-test-container">
        <div class="agent-info">
            <h1 id="agent-name">Loading Agent...</h1>
            <p id="agent-description">Preparing voice test interface</p>
        </div>

        <div id="connection-status" class="connection-status">
            <strong>Status:</strong> <span id="status-text">Not Connected</span>
        </div>

        <div id="error-container"></div>

        <div class="voice-controls">
            <button id="connect-btn" class="voice-btn btn-connect">
                <span id="connect-icon">üîó</span>
                <span id="connect-text">Connect to Agent</span>
            </button>
            
            <button id="mute-btn" class="voice-btn btn-mute" disabled>
                <span id="mute-icon">üé§</span>
                <span id="mute-text">Microphone On</span>
            </button>
            
            <button id="disconnect-btn" class="voice-btn btn-disconnect" disabled>
                <span>üìû</span>
                <span>Disconnect</span>
            </button>
        </div>

        <div class="audio-visualizer">
            <div class="audio-bars" id="audio-bars">
                <!-- Audio bars will be generated by JavaScript -->
            </div>
        </div>

        <div id="agent-status" class="agent-status status-initializing">
            Agent Status: Initializing
        </div>

        <div class="conversation-log">
            <h3>Conversation Log</h3>
            <div id="conversation-content">
                <p>Start a conversation with your voice agent...</p>
            </div>
        </div>
    </div>

    <script>
        class VoiceAgentTester {
            constructor() {
                // Check if LiveKit is loaded
                if (typeof window.LiveKit === 'undefined') {
                    console.error('LiveKit client library not loaded');
                    document.getElementById('error-container').innerHTML = `
                        <div class="error-message">
                            LiveKit client library failed to load. Please refresh the page or check your internet connection.
                        </div>
                    `;
                    return;
                }

                this.room = null;
                this.isConnected = false;
                this.isMuted = false;
                this.agentId = null;
                this.sessionInfo = null;
                this.audioContext = null;
                this.analyser = null;
                this.agentAudioTrack = null;
                this.userAudioTrack = null;
                
                this.initializeUI();
                this.initializeFromURL();
            }

            initializeUI() {
                // Get UI elements
                this.connectBtn = document.getElementById('connect-btn');
                this.muteBtn = document.getElementById('mute-btn');
                this.disconnectBtn = document.getElementById('disconnect-btn');
                this.statusElement = document.getElementById('status-text');
                this.connectionStatus = document.getElementById('connection-status');
                this.agentStatusElement = document.getElementById('agent-status');
                this.conversationContent = document.getElementById('conversation-content');
                this.errorContainer = document.getElementById('error-container');

                // Bind event listeners
                this.connectBtn.addEventListener('click', () => this.connectToAgent());
                this.muteBtn.addEventListener('click', () => this.toggleMute());
                this.disconnectBtn.addEventListener('click', () => this.disconnect());

                // Initialize audio visualizer
                this.initializeAudioVisualizer();
            }

            initializeFromURL() {
                // Get agent ID from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                this.agentId = urlParams.get('agentId');
                
                if (!this.agentId) {
                    this.showError('No agent ID provided in URL');
                    return;
                }

                this.loadAgentInfo();
            }

            async loadAgentInfo() {
                try {
                    const response = await fetch(`http://localhost:8000/api/agents/${this.agentId}`);
                    const data = await response.json();
                    
                    document.getElementById('agent-name').textContent = data.name || 'Voice Agent';
                    document.getElementById('agent-description').textContent = 
                        `${data.company_name || 'Company'} ‚Ä¢ Voice ID: ${data.voice_id || 'alloy'}`;
                    
                } catch (error) {
                    console.error('Error loading agent info:', error);
                    this.showError('Failed to load agent information');
                }
            }

            async connectToAgent() {
                try {
                    this.setConnectButtonState('connecting');
                    this.updateStatus('Connecting...', 'connecting');

                    // Create voice session
                    const sessionResponse = await fetch(`http://localhost:8000/api/voice/${this.agentId}/session`, {
                        method: 'POST'
                    });

                    if (!sessionResponse.ok) {
                        throw new Error(`Failed to create session: ${sessionResponse.statusText}`);
                    }

                    this.sessionInfo = await sessionResponse.json();
                    
                    if (!this.sessionInfo.success) {
                        throw new Error(this.sessionInfo.message || 'Failed to create voice session');
                    }

                    // Connect to LiveKit room
                    await this.connectToRoom();

                } catch (error) {
                    console.error('Connection error:', error);
                    this.showError(`Connection failed: ${error.message}`);
                    this.setConnectButtonState('disconnected');
                    this.updateStatus('Connection Failed', 'error');
                }
            }

            async connectToRoom() {
                try {
                    // Check if LiveKit is available
                    if (typeof LiveKit === 'undefined') {
                        throw new Error('LiveKit client library not loaded. Please refresh the page.');
                    }

                    // Create LiveKit room instance
                    this.room = new window.LiveKit.Room({
                        adaptiveStream: true,
                        dynacast: true
                    });

                    // Set up event listeners
                    this.setupRoomEventListeners();

                    // Connect to room
                    await this.room.connect(
                        this.sessionInfo.livekit_ws_url,
                        this.sessionInfo.livekit_token,
                        {
                            autoSubscribe: true,
                            publishDefaults: {
                                audioPreset: LiveKit.AudioPresets.music
                            }
                        }
                    );

                    // Enable microphone
                    await this.room.localParticipant.enableCameraAndMicrophone();
                    this.userAudioTrack = this.room.localParticipant.audioTracks.values().next().value?.track;

                    this.isConnected = true;
                    this.setConnectButtonState('connected');
                    this.updateStatus('Connected to Agent', 'connected');
                    this.muteBtn.disabled = false;
                    this.disconnectBtn.disabled = false;

                    this.addConversationEntry('system', 'Connected! You can now talk to your voice agent.');

                } catch (error) {
                    console.error('Room connection error:', error);
                    this.showError(`Failed to connect to voice room: ${error.message}`);
                    this.setConnectButtonState('disconnected');
                }
            }

            setupRoomEventListeners() {
                this.room.on('participantConnected', (participant) => {
                    console.log('Participant connected:', participant.identity);
                    
                    if (participant.identity.includes('agent')) {
                        this.addConversationEntry('system', 'Voice agent joined the conversation');
                        this.updateAgentStatus('listening');
                    }
                });

                this.room.on('trackSubscribed', (track, publication, participant) => {
                    if (track.kind === 'audio' && participant.identity.includes('agent')) {
                        this.agentAudioTrack = track;
                        this.setupAgentAudioAnalysis();
                        console.log('Subscribed to agent audio track');
                    }
                });

                this.room.on('dataReceived', (payload, participant) => {
                    try {
                        const data = JSON.parse(new TextDecoder().decode(payload));
                        
                        if (data.type === 'agent_state') {
                            this.updateAgentStatus(data.state);
                        } else if (data.type === 'transcription') {
                            if (data.participant === 'user') {
                                this.addConversationEntry('user', data.text);
                            } else if (data.participant === 'agent') {
                                this.addConversationEntry('agent', data.text);
                            }
                        }
                    } catch (error) {
                        console.error('Error parsing data:', error);
                    }
                });

                this.room.on('disconnected', () => {
                    this.handleDisconnection();
                });

                this.room.on('reconnecting', () => {
                    this.updateStatus('Reconnecting...', 'connecting');
                });

                this.room.on('reconnected', () => {
                    this.updateStatus('Reconnected', 'connected');
                });
            }

            toggleMute() {
                if (!this.isConnected || !this.userAudioTrack) return;

                this.isMuted = !this.isMuted;
                this.userAudioTrack.setEnabled(!this.isMuted);

                const muteIcon = document.getElementById('mute-icon');
                const muteText = document.getElementById('mute-text');

                if (this.isMuted) {
                    muteIcon.textContent = 'üîá';
                    muteText.textContent = 'Microphone Off';
                    this.muteBtn.style.background = '#e74c3c';
                } else {
                    muteIcon.textContent = 'üé§';
                    muteText.textContent = 'Microphone On';
                    this.muteBtn.style.background = '#f39c12';
                }
            }

            async disconnect() {
                if (this.room) {
                    await this.room.disconnect();
                }
                this.handleDisconnection();
            }

            handleDisconnection() {
                this.isConnected = false;
                this.room = null;
                this.agentAudioTrack = null;
                this.userAudioTrack = null;

                this.setConnectButtonState('disconnected');
                this.updateStatus('Disconnected', 'error');
                this.updateAgentStatus('initializing');

                this.muteBtn.disabled = true;
                this.disconnectBtn.disabled = true;
                this.isMuted = false;

                const muteIcon = document.getElementById('mute-icon');
                const muteText = document.getElementById('mute-text');
                muteIcon.textContent = 'üé§';
                muteText.textContent = 'Microphone On';
                this.muteBtn.style.background = '#f39c12';

                this.addConversationEntry('system', 'Disconnected from voice agent');
            }

            setConnectButtonState(state) {
                const connectIcon = document.getElementById('connect-icon');
                const connectText = document.getElementById('connect-text');

                switch (state) {
                    case 'connecting':
                        this.connectBtn.disabled = true;
                        connectIcon.innerHTML = '<div class="loading-spinner"></div>';
                        connectText.textContent = 'Connecting...';
                        break;
                    case 'connected':
                        this.connectBtn.disabled = true;
                        connectIcon.textContent = '‚úÖ';
                        connectText.textContent = 'Connected';
                        this.connectBtn.style.background = '#27ae60';
                        break;
                    case 'disconnected':
                        this.connectBtn.disabled = false;
                        connectIcon.textContent = 'üîó';
                        connectText.textContent = 'Connect to Agent';
                        this.connectBtn.style.background = '#3498db';
                        break;
                }
            }

            updateStatus(text, type) {
                this.statusElement.textContent = text;
                this.connectionStatus.className = `connection-status ${type}`;
            }

            updateAgentStatus(status) {
                const statusMap = {
                    'initializing': { text: 'Agent Status: Initializing', class: 'status-initializing' },
                    'listening': { text: 'Agent Status: Listening üëÇ', class: 'status-listening' },
                    'thinking': { text: 'Agent Status: Thinking ü§î', class: 'status-thinking' },
                    'speaking': { text: 'Agent Status: Speaking üó£Ô∏è', class: 'status-speaking' }
                };

                const statusInfo = statusMap[status] || statusMap['initializing'];
                this.agentStatusElement.textContent = statusInfo.text;
                this.agentStatusElement.className = `agent-status ${statusInfo.class}`;
            }

            addConversationEntry(type, text) {
                const entry = document.createElement('div');
                entry.className = `conversation-entry ${type}`;
                
                const timestamp = new Date().toLocaleTimeString();
                const label = type === 'user' ? 'You' : type === 'agent' ? 'Agent' : 'System';
                
                entry.innerHTML = `<strong>[${timestamp}] ${label}:</strong> ${text}`;
                
                this.conversationContent.appendChild(entry);
                this.conversationContent.scrollTop = this.conversationContent.scrollHeight;
            }

            initializeAudioVisualizer() {
                const barsContainer = document.getElementById('audio-bars');
                const barCount = 20;

                // Create audio bars
                for (let i = 0; i < barCount; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'audio-bar';
                    barsContainer.appendChild(bar);
                }

                this.audioBars = barsContainer.children;
                this.startAudioVisualization();
            }

            startAudioVisualization() {
                const animate = () => {
                    // Simple animation when not connected to show the interface is working
                    if (!this.isConnected) {
                        Array.from(this.audioBars).forEach((bar, index) => {
                            const height = Math.sin(Date.now() / 200 + index) * 20 + 30;
                            bar.style.height = `${Math.max(4, height)}px`;
                        });
                    }
                    
                    requestAnimationFrame(animate);
                };
                
                animate();
            }

            setupAgentAudioAnalysis() {
                // This would typically analyze the agent's audio for real-time visualization
                // For now, we'll show activity when the agent is speaking
                if (this.agentAudioTrack) {
                    console.log('Agent audio analysis setup - track available');
                }
            }

            showError(message) {
                this.errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
                setTimeout(() => {
                    this.errorContainer.innerHTML = '';
                }, 5000);
            }
        }

        // Initialize the voice agent tester when LiveKit is ready
        window.addEventListener('livekitReady', () => {
            console.log('LiveKit ready event received, initializing...');
            if (typeof window.LiveKit !== 'undefined') {
                console.log('LiveKit loaded successfully:', window.LiveKit);
                new VoiceAgentTester();
            } else {
                console.error('LiveKit ready event fired but LiveKit not available');
            }
        });
        
        // Fallback for direct loading
        window.addEventListener('load', () => {
            // Wait a bit to see if the module loads
            setTimeout(() => {
                if (typeof window.LiveKit !== 'undefined') {
                    console.log('LiveKit loaded via fallback:', window.LiveKit);
                    new VoiceAgentTester();
                } else {
                    console.error('LiveKit failed to load completely');
                    document.body.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: red;">
                            <h2>Error: LiveKit Failed to Load</h2>
                            <p>Unable to load the LiveKit client library.</p>
                            <p>Please try:</p>
                            <ul style="text-align: left; display: inline-block;">
                                <li>Refreshing the page</li>
                                <li>Checking your internet connection</li>
                                <li>Disabling ad blockers or script blockers</li>
                                <li>Using a different browser</li>
                            </ul>
                            <button onclick="location.reload()">Refresh Page</button>
                        </div>
                    `;
                }
            }, 2000);
        });
    </script>
</body>
</html>
